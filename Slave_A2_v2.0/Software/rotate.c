/**
 * @File Name: rotate.c
 * @brief
 * @author qz (zheqiu2021@163.com)
 * @version 0.1
 * @date 2022-04-08
 *
 * @copyright Copyright (c) 2022
 */
#include "rotate.h"

#include <math.h>

#define PI 3.1415926f

uint8_t flag[9] = {0}; /* 正反转标志 */
uint8_t cnt = 0;
/* 各轨迹点对应的关节角度 */
/* 基节、大腿、小腿同时运动时的关节角度 */
const float traj1[80][3] = {
    {0.4573, 0.4768, -1.5169},   {0.4571, 0.4761, -1.5158},
    {0.4553, 0.4713, -1.5084},   {0.4509, 0.4597, -1.4907},
    {0.4433, 0.4398, -1.4600},   {0.4322, 0.4111, -1.4157},
    {0.4177, 0.3740, -1.3582},   {0.3999, 0.3298, -1.2893},
    {0.3795, 0.2802, -1.2114},   {0.3572, 0.2274, -1.1277},
    {0.3336, 0.1737, -1.0418},   {0.3095, 0.1217, -0.9574},
    {0.2859, 0.0737, -0.8778},   {0.2633, 0.0319, -0.8065},
    {0.2425, -0.0020, -0.7459},  {0.2239, -0.0269, -0.6978},
    {0.2076, -0.0425, -0.6628},  {0.1938, -0.0494, -0.6403},
    {0.1818, -0.0491, -0.6279},  {0.1711, -0.0446, -0.6215},
    {0.1711, -0.0446, -0.6215},  {0.1606, -0.0397, -0.6159},
    {0.1503, -0.0363, -0.6083},  {0.1404, -0.0357, -0.5973},
    {0.1309, -0.0385, -0.5823},  {0.1219, -0.0450, -0.5630},
    {0.1133, -0.0550, -0.5396},  {0.1050, -0.0681, -0.5129},
    {0.0971, -0.0838, -0.4836},  {0.0894, -0.1012, -0.4530},
    {0.0817, -0.1195, -0.4221},  {0.0740, -0.1378, -0.3922},
    {0.0660, -0.1551, -0.3646},  {0.0578, -0.1707, -0.3403},
    {0.0492, -0.1838, -0.3201},  {0.0402, -0.1940, -0.3045},
    {0.0307, -0.2011, -0.2938},  {0.0208, -0.2053, -0.2876},
    {0.0105, -0.2070, -0.2851},  {0.0000, -0.2073, -0.2847},
    {0.0000, -0.2073, -0.2847},  {-0.0105, -0.2070, -0.2851},
    {-0.0208, -0.2053, -0.2876}, {-0.0307, -0.2011, -0.2938},
    {-0.0402, -0.1940, -0.3045}, {-0.0492, -0.1838, -0.3201},
    {-0.0578, -0.1707, -0.3403}, {-0.0660, -0.1551, -0.3646},
    {-0.0740, -0.1378, -0.3922}, {-0.0817, -0.1195, -0.4221},
    {-0.0894, -0.1012, -0.4530}, {-0.0971, -0.0838, -0.4836},
    {-0.1050, -0.0681, -0.5129}, {-0.1133, -0.0550, -0.5396},
    {-0.1309, -0.0385, -0.5823}, {-0.1404, -0.0357, -0.5973},
    {-0.1503, -0.0363, -0.6083}, {-0.1606, -0.0397, -0.6159},
    {-0.1711, -0.0446, -0.6215}, {-0.1711, -0.0446, -0.6215},
    {-0.1818, -0.0491, -0.6279}, {-0.1938, -0.0494, -0.6403},
    {-0.2076, -0.0425, -0.6628}, {-0.2239, -0.0269, -0.6978},
    {-0.2425, -0.0020, -0.7459}, {-0.2859, 0.0737, -0.8778},
    {-0.3095, 0.1217, -0.9574},  {-0.3336, 0.1737, -1.0418},
    {-0.3572, 0.2274, -1.1277},  {-0.3795, 0.2802, -1.2114},
    {-0.3999, 0.3298, -1.2893},  {-0.4177, 0.3740, -1.3582},
    {-0.4322, 0.4111, -1.4157},  {-0.4433, 0.4398, -1.4600},
    {-0.4509, 0.4597, -1.4907},  {-0.4553, 0.4713, -1.5084},
    {-0.4571, 0.4761, -1.5158},  {-0.4573, 0.4768, -1.5169}};
/* 大腿、小腿不动，基节转动时的关节角度 */
const float traj2[80][3] = {
    {-0.4573, 0, 0},  {-0.4573, 0, 0},  {-0.4573, 0, 0},  {-0.4573, 0, 0},
    {-0.4573, 0, 0},  {-0.4573, 0, 0},  {-0.4573, 0, 0},  {-0.4573, 0, 0},
    {-0.4573, 0, 0},  {-0.4573, 0, 0},  {-0.4573, 0, 0},  {-0.4573, 0, 0},
    {-0.4572, 0, 0},  {-0.4570, 0, 0},  {-0.4567, 0, 0},  {-0.4563, 0, 0},
    {-0.4555, 0, 0},  {-0.4545, 0, 0},  {-0.4530, 0, 0},  {-0.4508, 0, 0},
    {-0.4479, 0, 0},  {-0.4440, 0, 0},  {-0.4388, 0, 0},  {-0.4323, 0, 0},
    {-0.4241, 0, 0},  {-0.4140, 0, 0},  {-0.4018, 0, 0},  {-0.3872, 0, 0},
    {-0.3701, 0, 0},  {-0.3504, 0, 0},  {-0.3280, 0, 0},  {-0.3028, 0, 0},
    {-0.2749, 0, 0},  {-0.2444, 0, 0},  {-0.2114, 0, 0},  {-0.1762, 0, 0},
    {-0.1392, 0, 0},  {-0.1005, 0, 0},  {-0.0608, 0, 0},  {-0.0203, 0, 0},
    {0.0203, 0, 0},   {0.0608, 0.0, 0}, {0.1005, 0, 0},   {0.1392, 0.0, 0},
    {0.1762, 0, 0},   {0.2114, 0.0, 0}, {0.2444, 0.0, 0}, {0.2749, 0.0, 0},
    {0.3028, 0.0, 0}, {0.3280, 0.0, 0}, {0.3504, 0.0, 0}, {0.3701, 0.0, 0},
    {0.3872, 0.0, 0}, {0.4018, 0.0, 0}, {0.4140, 0.0, 0}, {0.4241, 0.0, 0},
    {0.4323, 0.0, 0}, {0.4388, 0.0, 0}, {0.4440, 0.0, 0}, {0.4479, 0.0, 0},
    {0.4508, 0.0, 0}, {0.4530, 0.0, 0}, {0.4545, 0.0, 0}, {0.4555, 0.0, 0},
    {0.4563, 0.0, 0}, {0.4567, 0.0, 0}, {0.4570, 0.0, 0}, {0.4572, 0.0, 0},
    {0.4573, 0.0, 0}, {0.4573, 0.0, 0}, {0.4573, 0.0, 0}, {0.4573, 0.0, 0},
    {0.4573, 0.0, 0}, {0.4573, 0.0, 0}, {0.4573, 0.0, 0}, {0.4573, 0.0, 0},
    {0.4573, 0.0, 0}, {0.4573, 0.0, 0}, {0.4573, 0.0, 0}, {0.4573, 0.0, 0}};
float c, d;
/**
 * @brief  目标角度切换
 * @param  traj
 */
void tarangle_switch(const float (*traj)[3]) {
    cnt = (cnt <= 78) ? cnt : 78;
    motor_2006[0].tarangle =
        CIRCLE_MULTIPLE * 36 * (traj[0][0] - traj[cnt + 1][0]);
    for (int j = 1; j < 3; ++j) {
        motor_2006[j].tarangle =
            CIRCLE_MULTIPLE * 36 *
            angle_conversion(traj[0][j] - traj[cnt + 1][j]);
        c = angle_conversion(traj[0][1] - traj[cnt + 1][1]);
    }
    ++cnt;
}

/**
 * @brief  将关节转动角度转换为电机转动圈数
 * @param  theta：关节转动角度（rad）
 * @return float
 */
float angle_conversion(float theta) { return 36 * sin(theta) / PI; }
